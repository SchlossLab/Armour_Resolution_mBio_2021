---
title: "Exploratory: Optimal Resolution"
author: "Courtney R Armour"
output: html_document
---

updated: `r Sys.Date()`

```{r setup_environment, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message=FALSE)
options(scipen=999)

library(tidyverse)
library(knitr)
library(kableExtra)
library(ggpubr)
library(nationalparkcolors)
library(data.table)
library(cowplot)
library(pROC)

#given a number, adds correct commas
set_commas <- function(num){
  
}
```

```{r data_setup}

# Variables
models <- c("rf","glmnet","xgbTree","svmRadial","rpart2")
levels <- c("phylum","class","order","family","genus","otu","asv")
levels_names <- c("Phylum","Class","Order","Family","Genus","OTU","ASV")
pal <- park_palette("Everglades",length(models))
names(pal) <- models
pal2 <- park_palette("Everglades",length(models))
names(pal2) <- c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree")

# Generate dataframe of all results and tables of the median cv and test AUCs
full_df <- NULL
auc_df <- NULL
cv_table <- tibble(level=c("phylum","class","order","family","genus","otu","asv"))
t_table <- tibble(level=c("phylum","class","order","family","genus","otu","asv"))

for( m in models ){
  phylum <- read_csv(paste0("../data/process/combined-phylum-",m,".csv"),
                     col_types = c(method = col_character(),.default=col_double())) %>% 
    mutate(level="phylum")
  class <- read_csv(paste0("../data/process/combined-class-",m,".csv"),
                     col_types = c(method = col_character(),.default=col_double())) %>% 
    mutate(level="class")
  order <- read_csv(paste0("../data/process/combined-order-",m,".csv"),
                     col_types = c(method = col_character(),.default=col_double())) %>% 
    mutate(level="order")
  family <- read_csv(paste0("../data/process/combined-family-",m,".csv"),
                     col_types = c(method = col_character(),.default=col_double())) %>% 
    mutate(level="family")
  genus <- read_csv(paste0("../data/process/combined-genus-",m,".csv"),
                     col_types = c(method = col_character(),.default=col_double())) %>%
    mutate(level="genus")
  otu <- read_csv(paste0("../data/process/combined-otu-",m,".csv"),
                     col_types = c(method = col_character(),.default=col_double())) %>%
    mutate(level="otu")
  asv <- read_csv(paste0("../data/process/combined-asv-",m,".csv"),
                     col_types = c(method = col_character(),.default=col_double())) %>%
    mutate(level="asv")
  
  model_df <- bind_rows(phylum,class,order,family,genus,otu,asv)
    
  full_df <- bind_rows(full_df,model_df)
  
  m_auc.df <- select(model_df,cv_metric_AUC,AUC,method,level) %>% 
    rename(test_AUC=AUC) %>% 
    pivot_longer(cols = c("cv_metric_AUC","test_AUC"),names_to="auc_type",values_to="AUC")
  
  m_auc.df$level <- factor(m_auc.df$level,levels=c("phylum","class","order","family","genus","otu","asv"))
  
  auc_df <- bind_rows(auc_df,m_auc.df)
  
  cv_med <- m_auc.df %>%
    filter(auc_type == "cv_metric_AUC") %>%
    group_by(level) %>% 
    summarise(!!m := median(AUC),.groups = 'drop') 
  
  t_med <- m_auc.df %>% 
    filter(auc_type == "test_AUC") %>%
    group_by(level) %>% 
    summarise(!!m := median(AUC),.groups = 'drop') 
      
  cv_table <- inner_join(cv_table,cv_med,by="level")
  t_table <- inner_join(t_table,t_med,by="level")
}

write_csv(t_table,"./figures/median_test_auc.csv")

#compare two models levels within a taxonomic level
p.table.level <- read_csv("../analysis/pvalues_by_level.csv",
                     col_types = c(p_value = col_double(),.default=col_character()))
#compare two taxonomic levels within a model type
p.table.model <- read_csv("../analysis/pvalues_by_model.csv",
                     col_types = c(p_value = col_double(),.default=col_character()))


```

## Table of Contents

-   [Input data overview](#input-data-overview)

-   [Hyperparameter Performance](#hyperparameter-performance)

-   [Model Performance](#model-performance)

    -   [Random Forest](#random-forest-model-performance-with-significance)

-   [DADA2 Comparison](#dada2-comparison)

-   [Feature Importance](#feature-importance)

-   [Feature Importance - threshold 0.9](#importance90)

-   [Prevalence](#prevalence)

-   [Prevalence VS Difference in Median Abundance](#prev-diff-abund)

-   [Prevalence by Group](#prevalence-by-group)

-   [Median Non-Zero Relative Abundance by Group](#med-relabund-group)

-   [Sensitivity at 90% Specificity](#sens-90spec)

-   [Averaged ROC curves](#avg-roc)  


## Input data overview {#input-data-overview}

To total number of samples and features before and after preprocessing for each taxnomic level.

```{r input}

input <- read_csv("../analysis/input_values.csv",
                  col_types = c(level = col_character(), .default = col_double()))

kable(input)
```

## Color Palette

```{r color-pal,include=F}
#color palette
#colors <- c("#7E362A","#D04C44","#E6A444","#6C887A","#83BCC3","#5B6B86","#754A60")
colors <- c("#D04C44","#E7834E","#E6A444","#829E88","#83BCC3","#7989A4","#B29ABA")
names(colors) <- levels

colors2 <- colors
names(colors2) <- levels_names
pie(rep(1,length(colors2)),col=colors2,labels = names(colors2))
```

## Hyperparameter Performance {#hyperparameter-performance}

Plots of HP performance for each model/taxonomic level

### Random Forest

The default hyperparameter (mtry) selection for RF is:

1.  sqrt_features / 2
2.  sqrt_features
3.  sqrt_features \* 2

Based on previous results, I added mtry=1 for Phylum through Genus levels and mtry=100 for OTU and ASV levels. This set of hyperparameters seems to cover the optimal range for each taxonomic level.

![](../analysis/hp-rf.png)

### Logistic Regression

Two metrics: alpha and lambda\
By default alpha is set to zero (for L2 regularization) and lambda values are: 1e-04, 1e-03, 1e-02, 1e-01, 1e+00, 1e+01 I added 1e-05 as a lambda value for phylum and class, and higher values of lambda for the rest

![](../analysis/hp-glmnet.png)

### Decision Tree

The default hyperparameters were retained for decision tree (maxdepth = 1 2 4 8 16 30). It would not allow larger maxdepth than 30.

![](../analysis/hp-rpart2.png)

### XGBoost

(needs adjustment)

### SVM Radial

![](../analysis/hp-svmRadial.png)

## Model Performance {#model-performance}

```{r plot_by_method,fig.height = 3.5, fig.width = 10, fig.align = "center"}

df_by_method <- full_df %>% 
  select(cv_metric_AUC,AUC,method,level) %>% 
  rename(test_AUC=AUC,cv_AUC=cv_metric_AUC) %>% 
  pivot_longer(cols=c("cv_AUC","test_AUC"),names_to="auc_type",values_to="AUC")

df_by_method$method <- factor(df_by_method$method,
                        levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                        labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))

ggplot(df_by_method,aes(x=factor(level,
                            levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
                   y=AUC, fill=auc_type)) + 
    geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
    geom_boxplot() + 
    facet_grid(.~method) + 
    theme_bw() + xlab("") + ylab("AUROC") +
    theme(legend.position ="top",
          axis.text.x = element_text(angle = 45,hjust = 1)) 
ggsave("./figures/performance_by_method.png")
```

```{r plot_by_level, fig.height = 6, fig.width = 10, fig.align = "center"}
df_by_level <- full_df %>% 
  select(cv_metric_AUC,AUC,method,level) %>% 
  rename(test_AUC=AUC,cv_AUC=cv_metric_AUC) %>% 
  pivot_longer(cols=c("cv_AUC","test_AUC"),names_to="auc_type",values_to="AUC") %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree")))
                       
ggplot(df_by_level,aes(x=method, y=AUC, fill=auc_type)) + 
  geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
  geom_boxplot() + 
  facet_wrap(.~level,nrow = 2) + 
  theme_bw() + xlab("") + ylab("AUROC") + 
  theme(legend.position ="top",
        axis.text.x = element_text(angle = 45,hjust = 1)) 
ggsave("./figures/performance_by_tax.png")

```

```{r plot_all, out.width="100%",fig.height=4}
df_all <- full_df %>% 
  select(cv_metric_AUC,AUC,method,level) %>% 
  rename(test_AUC=AUC,cv_AUC=cv_metric_AUC) %>% 
  pivot_longer(cols=c("cv_AUC","test_AUC"),names_to="auc_type",values_to="AUC") %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree")))

df_all %>% 
  filter(auc_type == "test_AUC") %>% 
  ggplot(aes(x=level,y=AUC,fill=method)) + 
    geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
    geom_boxplot(alpha=0.9) + 
    theme_bw() + xlab("") + ylab("AUROC") + 
    theme(legend.position ="top",
          axis.text.x = element_text(angle = 0),
          axis.text = element_text(size=14)) +
    scale_fill_manual(values=pal2,name="Model") #+
  #guides(fill=guide_legend(nrow=2))
ggsave("./figures/all_model_level.png",width = 7,height=4,units="in")
```

### DADA2 Comparison {#dada2-comparison}

```{r dada2_input}

#mothur and dada2 input values
input_data <- bind_rows(read_csv("../analysis/input_values.csv",
                                 col_types = c(level = col_character(), .default = col_double())),
                        read_csv("../data/dada2/process/summary_input_values.csv",
                                 col_types = c(level = col_character(), .default = col_double())))

```

Since there are some that believe ASVs generated by Mothur are not as good as ASVs generated by DADA2, I ran a comparison. I used DADA2 (v1.18.0) to generate ASVs and ran them through the same mikropml model pipeline. I ran dada(..., pool=T) to caputure more rare ASVs and subsampled to XX reads after processing.

Below is a summary table of the number of features at each level. Interestingly there are only `r formatC(input_data %>% filter(level=="dada2") %>% pull(n_features),big.mark = ",",format="f",digits=0)` ASVs identified with DADA2 compared to `r formatC(input_data %>% filter(level=="asv") %>% pull(n_features),big.mark = ",",format="f",digits=0)` with Mothur. After preprocessing there are just `r input_data %>% filter(level=="dada2") %>% pull(n_features_preproc)` ASVs, about half of what we find with Mothur.

```{r dada2_table}
kable(input_data) %>% 
  kable_styling(bootstrap_options = "striped")
```

```{r dada2_auc}

mothur_df <- full_df %>% 
  filter(level=="asv") %>% 
  mutate(type="Mothur")

mothur_auc_df <- auc_df %>% 
  filter(level=="asv") %>% 
  mutate(type="Mothur")
  
dada2_df <- NULL
dada2_auc_df <- NULL
for( m in models ){
  asv <- read_csv(paste0("../data/dada2/process/combined-dada2-",m,".csv"),
                     col_types = c(method = col_character(),.default=col_double())) %>%
    mutate(type="DADA2")
  dada2_df <- bind_rows(dada2_df,asv)
    
  m_auc.df <- select(asv,cv_metric_AUC,AUC,method,type) %>% 
    rename(test_AUC=AUC) %>% 
    pivot_longer(cols = c("cv_metric_AUC","test_AUC"),names_to="auc_type",values_to="AUC")
  
  dada2_auc_df <- bind_rows(dada2_auc_df,m_auc.df)
}

md_df <- bind_rows(mothur_df,dada2_df)

md_auc_df <- bind_rows(mothur_auc_df,dada2_auc_df)


```

```{r dada2_stats}
dada2_p_level <- read.csv("../data/dada2/analysis/dada2_pvalues_by_level.csv")
dada2_p_model <- read.csv("../data/dada2/analysis/dada2_pvalues_by_model.csv")
```

```{r dada2_plot_auc,out.width="50%"}
mod_md_df <- md_df %>% 
  select(cv_metric_AUC,AUC,method,level,type) %>% 
  rename(test_AUC=AUC,cv_AUC=cv_metric_AUC) %>% 
  pivot_longer(cols=c("cv_AUC","test_AUC"),names_to="auc_type",values_to="AUC") %>% 
  mutate(method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree")))

mod_md_df %>% 
  filter(type=="DADA2") %>% 
  ggplot(aes(x=method, y=AUC, fill=auc_type)) + 
    geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
    geom_boxplot() + 
    theme_bw() + xlab("") + ylab("AUROC") + 
    theme(legend.position ="top",
          axis.text.x = element_text(angle = 45,hjust = 1)) +
    ggtitle("DADA2 ASV Model Performance across Models")

mod_md_df %>% 
  ggplot(aes(x=type, y=AUC, fill=auc_type)) + 
    geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
    geom_boxplot() + 
    facet_grid(.~method) +
    theme_bw() + xlab("") + ylab("AUROC") + 
    theme(legend.position ="top",
          axis.text.x = element_text(angle = 45,hjust = 1)) +
    ggtitle("DADA2 vs Mothur ASV Model Performance")

```

```{r dada2_plot_auc_wstat,out.width="50%"}

#subset to just test data
mod_md_auc_df <- md_auc_df %>% 
  filter(auc_type=="test_AUC") %>% 
  mutate(method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree")))

#compare different models with DADA2 ASVs
sub_stats_level <- dada2_p_level %>% 
  mutate(level=factor(level,levels=c("asv","dada2"),
                            labels=c("Mothur","DADA2")),
         model1=factor(model1,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree")),
         model2=factor(model2,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  mutate(sig=case_when(p_value >= 0.05 ~ "NS",
                       TRUE ~ "*")) %>% 
  mutate(y.position=seq.int(0.85,1.05,length.out = nrow(.))) %>% 
  rename(group1=model1,group2=model2) %>% 
  filter(sig=="NS")

mod_md_auc_df %>% 
  filter(type=="DADA2") %>% 
  ggplot(aes(x=method,y=AUC)) + 
    geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
    geom_boxplot(aes(fill=method)) +
    scale_fill_manual(values = pal2) + 
    scale_y_continuous(limits=c(0.2,1.05)) +
    theme_bw() + xlab("") + ylab("AUROC") +
    theme(legend.position ="none",
          axis.text.x = element_text(angle = 45,hjust = 1),
          panel.grid.major.x = element_blank(),
          axis.text = element_text(size=14)) +
    ggtitle("DADA2") +
    stat_summary(fun = mean, color="white",geom = "point", shape = 18, size = 3,show.legend = FALSE) +
    stat_pvalue_manual(sub_stats_level,label="sig")


#compare Mother and DADA2 ASVs across models
sub_stats_model <- dada2_p_model %>% 
   mutate(level1=factor(level1,levels=c("asv","dada2"),
                            labels=c("Mothur","DADA2")),
          level2=factor(level2,levels=c("asv","dada2"),
                            labels=c("Mothur","DADA2")),
         model=factor(model,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  mutate(sig=case_when(p_value >= 0.05 ~ "NS",
                       TRUE ~ "*")) %>% 
  #filter(sig=="NS") %>% 
  mutate(y.position=rep(0.85,length.out = nrow(.))) %>% 
  rename(group1=level1,group2=level2) %>% 
  mutate(p_value=case_when(p_value < 0.001 ~ round(p_value,digits=4),
                           TRUE ~ round(p_value,digits=2)))

mod_md_auc_df %>%
  rename(group=type,model=method) %>% 
  ggplot(aes(x=group,y=AUC,color=group)) +
    geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
    geom_jitter() +
    stat_summary(fun.data=median_hilow, fun.args=0.5, geom="crossbar", width=0.5, color="black") +
    #geom_boxplot(aes(fill=model)) +
    scale_y_continuous(limits=c(0.4,0.9)) +
    theme_bw() + xlab("") + ylab("AUROC") +
    theme(legend.position ="none",
          axis.text.x = element_text(angle = 45,hjust = 1),
          panel.grid.major.x = element_blank(),
          axis.text = element_text(size=14)) +
    ggtitle("DADA2 v Mothur ASVs") +
    facet_grid(~model) +
    stat_pvalue_manual(sub_stats_model,label="p_value")



```

```{r dada2_all, out.width="100%",fig.height=3}
dada2_auc_df %>% 
  rename(level=type) %>% 
  bind_rows(auc_df) %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv","DADA2"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV","DADA2")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(auc_type == "test_AUC") %>% 
  ggplot(aes(x=level,y=AUC,fill=method)) + 
    geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
    geom_boxplot() + 
    theme_bw() + xlab("") + ylab("AUROC") + 
    theme(legend.position ="top",
          axis.text.x = element_text(angle = 45,hjust = 1)) +
    scale_fill_manual(values=pal2,name="Model")
  

  
```

```{r dada2_rf_wstat}

# #subset to just test data
# mod_md_auc_df <- md_auc_df %>% 
#   filter(auc_type=="test_AUC",method=="rf") %>% 
#   mutate(method=factor(method,levels=c("rf"),
#                        labels=c("Random Forest")))
# 
# #compare different models with DADA2 ASVs
# sub_stats_dada2_rf <- dada2_p_model %>% 
#   filter(model=="rf") %>%    
#   mutate(sig=case_when(p_value >= 0.05 ~ "NS",
#                        TRUE ~ "*")) %>% 
#   mutate(y.position=seq.int(0.85,1.05,length.out = nrow(.))) %>% 
#   rename(group1=level1,group2=level2) %>% 
#   filter(sig=="NS")
# 
# mod_md_auc_df %>% 
#   filter(type=="DADA2") %>% 
#   ggplot(aes(x=method,y=AUC)) + 
#     geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
#     geom_boxplot(aes(fill=method)) +
#     scale_fill_manual(values = pal2) + 
#     scale_y_continuous(limits=c(0.2,1.05)) +
#     theme_bw() + xlab("") + ylab("AUROC") +
#     theme(legend.position ="none",
#           axis.text.x = element_text(angle = 45,hjust = 1),
#           panel.grid.major.x = element_blank(),
#           axis.text = element_text(size=14)) +
#     ggtitle("DADA2") +
#     stat_summary(fun = mean, color="white",geom = "point", shape = 18, size = 3,show.legend = FALSE) +
#     stat_pvalue_manual(sub_stats_level,label="sig")
# 
# 
# #compare Mother and DADA2 ASVs across models
# sub_stats_model <- dada2_p_model %>% 
#    mutate(level1=factor(level1,levels=c("asv","dada2"),
#                             labels=c("Mothur","DADA2")),
#           level2=factor(level2,levels=c("asv","dada2"),
#                             labels=c("Mothur","DADA2")),
#          model=factor(model,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
#                        labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
#   mutate(sig=case_when(p_value >= 0.05 ~ "NS",
#                        TRUE ~ "*")) %>% 
#   #filter(sig=="NS") %>% 
#   mutate(y.position=rep(0.85,length.out = nrow(.))) %>% 
#   rename(group1=level1,group2=level2) %>% 
#   mutate(p_value=case_when(p_value < 0.001 ~ round(p_value,digits=4),
#                            TRUE ~ round(p_value,digits=2)))
# 
# mod_md_auc_df %>%
#   rename(group=type,model=method) %>% 
#   ggplot(aes(x=group,y=AUC,color=group)) +
#     geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
#     geom_jitter() +
#     stat_summary(fun.data=median_hilow, fun.args=0.5, geom="crossbar", width=0.5, color="black") +
#     #geom_boxplot(aes(fill=model)) +
#     scale_y_continuous(limits=c(0.4,0.9)) +
#     theme_bw() + xlab("") + ylab("AUROC") +
#     theme(legend.position ="none",
#           axis.text.x = element_text(angle = 45,hjust = 1),
#           panel.grid.major.x = element_blank(),
#           axis.text = element_text(size=14)) +
#     ggtitle("DADA2 v Mothur ASVs") +
#     facet_grid(~model) +
#     stat_pvalue_manual(sub_stats_model,label="p_value")



```

### Random Forest Model Performance with Significance {#random-forest-model-performance-with-significance}

Random Forest on OTU level data yields the highest median AUC, followed by Family, Genus, and ASV. While the OTU AUC is not significantly higher than that of Family or Genus level, it is significantly higher than ASV.

::: {.row}
::: {.col-md-6}
```{r rf_table,echo=FALSE}
t_table %>%
  select(level,rf) %>% 
  mutate(rf=round(rf,digits = 3)) %>% 
  rename("Median AUC"=rf,"Level"=level) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position="center")
```
:::

::: {.col-md-6}
```{r rf_plot}
m <- "Random Forest"

sub_df <- auc_df %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv"),
                       labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(method==m & auc_type=="test_AUC")

# sub_stats <- p.table.model %>% 
#    mutate(level1=factor(level1,levels=c("phylum","class","order","family","genus","otu","asv"),
#                             labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
#           level2=factor(level2,levels=c("phylum","class","order","family","genus","otu","asv"),
#                             labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
#          model=factor(model,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
#                        labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
#   filter(model==m) %>% 
#   select(-model) %>% 
#   pivot_wider(names_from=level2,values_from=p_value) %>% 
#   column_to_rownames(var="level1")
# sub_stats <- sub_stats[levels_names[1:6],levels_names[2:7]]




# sub_stats <- sub_stats %>% 
#   mutate(y.position=seq.int(0.85,1.05,length.out = nrow(sub_stats))) %>% 
#   rename(group1=level1,group2=level2) 

ggplot(sub_df,aes(x=factor(level,levels=c("ASV", "OTU","Genus","Family","Order","Class", "Phylum")),y=AUC)) + 
  geom_jitter(aes(fill=level,color=level),height = 0, width = 0.2,shape=21,size=2) +
  stat_summary(fun.data = median_hilow,fun.args=0.5, geom="crossbar", width=0.5, color="black") +
  #scale_fill_manual(values = alpha(pal2[m],0.6)) +
  #scale_color_manual(values = pal2[m]) +
  scale_fill_manual(values = alpha(colors2,0.5)) +
  scale_color_manual(values = colors2) +
  scale_y_continuous(limits=c(0.45,0.87),breaks = seq(0.5,0.8,0.1),expand=c(0,0)) +
  theme_bw() + xlab("") + ylab("AUROC") +
  theme(legend.position ="none",
        #axis.text.x = element_text(angle = 45,hjust = 1),
        panel.grid.major.y = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=12)) +
  coord_flip() +
  annotate("text",x=levels_names,y=rep(0.85,length(levels_names)),label=c("A","B","C","D,E","D,E","D","E")) +
  geom_hline(yintercept = 0.5,color="grey",lty="dashed") 
ggsave("./figures/rf_with_stats.png",width = 4.5,height=5,units="in")

```

```{r rf_wstat_options,include=F}

# OPTION 1 ------------
m <- "Random Forest"

sub_df <- auc_df %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv"),
                       labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(method==m & auc_type=="test_AUC")

sub_stats <- p.table.model %>% 
   mutate(level1=factor(level1,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
          level2=factor(level2,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         model=factor(model,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(model==m) %>% 
  mutate(sig=case_when(p_value >= 0.05 ~ "NS",
                       TRUE ~ "*")) %>% 
  filter(sig=="NS")

sub_stats <- sub_stats %>% 
  mutate(y.position=seq.int(0.85,1.05,length.out = nrow(sub_stats))) %>% 
  rename(group1=level1,group2=level2) 

ggplot(sub_df,aes(x=level,y=AUC)) + 
  geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
  geom_boxplot(aes(fill=method,alpha=0.8)) +
  scale_fill_manual(values = pal2[m]) + 
  scale_y_continuous(limits=c(0.4,1.05)) +
  theme_bw() + xlab("") + ylab("AUROC") +
  theme(legend.position ="none",
        axis.text.x = element_text(angle = 45,hjust = 1),
        panel.grid.major.x = element_blank(),
        axis.text = element_text(size=14)) +
  #ggtitle(m) +
  #stat_summary(fun = mean, color="white",geom = "point", shape = 18, size = 3,show.legend = FALSE) +
  stat_pvalue_manual(sub_stats,label="sig")

# OPTION 2 ------------

ggplot(sub_df,aes(x=factor(level,levels=c("ASV", "OTU","Genus","Family","Order","Class", "Phylum")),
                           y=AUC)) + 
  #geom_jitter(aes(color=method,width=0,height=0.2)) +
  geom_boxplot(aes(fill=level,alpha=0.8)) +
  #scale_fill_manual(values = pal2[m]) +
  #scale_color_manual(values = pal2[m]) +
  #scale_x_continuous(limits=c(0.4,1)) +
  theme_bw() + xlab("") + ylab("AUROC") +
  theme(legend.position ="none",
        #axis.text.x = element_text(angle = 45,hjust = 1),
        panel.grid.major.x = element_blank(),
        axis.text = element_text(size=14)) +
  #ggtitle(m) +
  stat_pvalue_manual(sub_stats,label="sig",coord.flip = T,angle = 0,hjust=0) +
  coord_flip() +
  geom_hline(yintercept = 0.5,color="grey",lty="dashed") 

# OPTION 3 ------------

sub_df <- auc_df %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv"),
                       labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(method==m & auc_type=="test_AUC")

sub_stats <- p.table.model %>% 
   mutate(level1=factor(level1,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
          level2=factor(level2,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         model=factor(model,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(model==m) %>% 
  mutate(sig=case_when(p_value >= 0.05 ~ "NS",
                       TRUE ~ "*")) %>% 
  filter(sig=="NS")

sub_stats <- sub_stats %>% 
  mutate(y.position=seq.int(0.85,1.05,length.out = nrow(sub_stats))) %>% 
  #mutate(y.position=c(0.85,0.95,0.9,.95)) %>%
  rename(group1=level1,group2=level2) 

ggplot(sub_df,aes(x=level,y=AUC)) + 
  geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
  #geom_boxplot(aes(fill=method)) +
  geom_jitter(aes(fill=method),height = 0, width = 0.2,alpha=0.8,shape=21) +
  stat_summary(fun.data = median_hilow,fun.args=0.5, geom="crossbar", width=0.5, color="black") +
  scale_fill_manual(values = pal2[m]) + 
  scale_y_continuous(limits=c(0.4,1.05),breaks = seq(0.4,1,0.1)) +
  theme_bw() + xlab("") + ylab("AUROC") +
  theme(legend.position ="none",
        #axis.text.x = element_text(angle = 45,hjust = 1),
        panel.grid.major.x = element_blank(),
        axis.text = element_text(size=14)) +
  #ggtitle(m) +
  #stat_summary(fun = mean, color="white",geom = "point", shape = 18, size = 3,show.legend = FALSE) +
  stat_pvalue_manual(sub_stats,label="sig")

# OPTION 4 ------------

sub_stats <- sub_stats %>% 
  mutate(y.position=seq.int(0.85,.95,length.out = nrow(sub_stats)))
  #mutate(y.position=c(0.85,0.95,0.9,.95))

ggplot(sub_df,aes(x=factor(level,levels=c("ASV", "OTU","Genus","Family","Order","Class", "Phylum")),
                           y=AUC)) + 
  geom_jitter(aes(fill=level),height = 0, width = 0.2,alpha=0.8,shape=21) +
  stat_summary(fun.data = median_hilow,fun.args=0.5, geom="crossbar", width=0.5, color="black") +
  #scale_fill_manual(values = pal2[m]) +
  #scale_color_manual(values = pal2[m]) +
  #scale_x_continuous(limits=c(0.4,1)) +
  theme_bw() + xlab("") + ylab("AUROC") +
  theme(legend.position ="none",
        #axis.text.x = element_text(angle = 45,hjust = 1),
        panel.grid.major.x = element_blank(),
        axis.text = element_text(size=14)) +
  scale_y_continuous(position = "right") +
  #ggtitle(m) +
  stat_pvalue_manual(sub_stats,label="sig",coord.flip = T,angle = 0,hjust=0) +
  coord_flip() +
  geom_hline(yintercept = 0.5,color="grey",lty="dashed") 

# OPTION 5 ------------

sub_df <- auc_df %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv"),
                       labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(method==m & auc_type=="test_AUC")

sub_stats <- p.table.model %>% 
   mutate(level1=factor(level1,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
          level2=factor(level2,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         model=factor(model,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(model==m) %>% 
  mutate(sig=case_when(p_value >= 0.05 ~ "NS",
                       TRUE ~ "*")) %>% 
  filter(sig!="NS") %>% 
  mutate(p_value_mod=case_when(p_value < 0.0001 ~ round(p_value,digits=5),
                               p_value < 0.001 ~ round(p_value,digits=4),
                               p_value < 0.01 ~ round(p_value,digits=3),
                               TRUE ~ round(p_value,digits=2)))

# sub_stats <- sub_stats %>% 
#   #mutate(y.position=seq.int(0.85,1.05,length.out = nrow(sub_stats))) %>% 
#   mutate(y.position=c(1,1,1,1,1,
#                       0.9,
#                       0.95,0.95,0.95,0.95,
#                       0.85,
#                       1.05,1.05,1.05,1.05,1.05,1.05)) %>% 
#   #mutate(y.position=c(0.85,0.95,0.9,.95)) %>%
#   rename(group1=level1,group2=level2) 

# ggplot(sub_df,aes(x=level,y=AUC)) + 
#   geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
#   #geom_boxplot(aes(fill=method)) +
#   geom_jitter(aes(fill=method),height = 0, width = 0.2,alpha=0.8,shape=21) +
#   stat_summary(fun.data = median_hilow,fun.args=0.5, geom="crossbar", width=0.5, color="black") +
#   scale_fill_manual(values = pal2[m]) + 
#   scale_y_continuous(limits=c(0.4,1.05),breaks = seq(0.4,1.05,0.1)) +
#   theme_bw() + xlab("") + ylab("AUROC") +
#   theme(legend.position ="none",
#         #axis.text.x = element_text(angle = 45,hjust = 1),
#         panel.grid.major.x = element_blank(),
#         axis.text = element_text(size=14)) +
#   #ggtitle(m) +
#   #stat_summary(fun = mean, color="white",geom = "point", shape = 18, size = 3,show.legend = FALSE) +
#   #stat_pvalue_manual(sub_stats,label="p_value_mod") 
#   stat_pvalue_manual(sub_stats,label="sig")
```

### Logistic Regression Model Performance with Significance

::: {.row}
::: {.col-md-6}
```{r glmnet_table}
t_table %>%
  select(level,glmnet) %>% 
  mutate(glmnet=round(glmnet,digits = 3)) %>% 
  rename("Median AUC"=glmnet,"Level"=level) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position="center")
```
:::

::: {.col-md-6}
```{r glmnet_plot}
## glmnet Model Performance
m <- "Logistic Regression"

sub_df <- auc_df %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv"),
                       labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(method==m & auc_type=="test_AUC")

sub_stats <- p.table.model %>% 
   mutate(level1=factor(level1,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
          level2=factor(level2,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         model=factor(model,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(model==m) %>% 
  mutate(sig=case_when(p_value >= 0.05 ~ "NS",
                       TRUE ~ "*")) %>% 
  filter(sig=="NS")

sub_stats <- sub_stats %>% 
  mutate(y.position=seq.int(0.85,1.05,length.out = nrow(sub_stats))) %>% 
  rename(group1=level1,group2=level2) 

ggplot(sub_df,aes(x=level,y=AUC)) + 
  geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
  geom_boxplot(aes(fill=method)) +
  scale_fill_manual(values = pal2[m]) + 
  scale_y_continuous(limits=c(0.2,1.05)) +
  theme_bw() + xlab("") + ylab("AUROC") +
  theme(legend.position ="none",
        axis.text.x = element_text(angle = 45,hjust = 1),
        panel.grid.major.x = element_blank(),
        axis.text = element_text(size=14)) +
  ggtitle(m) +
  stat_summary(fun = mean, color="white",geom = "point", shape = 18, size = 3,show.legend = FALSE) +
  stat_pvalue_manual(sub_stats,label="sig")
ggsave("./figures/glmnet_with_stats.png",width = 5,height=4,units="in")

```
:::
:::

### Decision Tree Model Performance with Significance

::: {.row}
::: {.col-md-6}
```{r rpart2_table,echo=FALSE}
t_table %>%
  select(level,rpart2) %>% 
  mutate(rpart2=round(rpart2,digits = 3)) %>% 
  rename("Median AUC"=rpart2,"Level"=level) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position="center")
```
:::

::: {.col-md-6}
```{r rpart2_plot,echo=F,message=F}
## rpart2 Model Performance
m <- "Decision Tree"

sub_df <- auc_df %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv"),
                       labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(method==m & auc_type=="test_AUC")

sub_stats <- p.table.model %>% 
   mutate(level1=factor(level1,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
          level2=factor(level2,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         model=factor(model,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(model==m) %>% 
  mutate(sig=case_when(p_value >= 0.05 ~ "NS",
                       TRUE ~ "*")) %>% 
  filter(sig=="NS")

sub_stats <- sub_stats %>% 
  mutate(y.position=seq.int(0.85,1.05,length.out = nrow(sub_stats))) %>% 
  rename(group1=level1,group2=level2) 

ggplot(sub_df,aes(x=level,y=AUC)) + 
  geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
  geom_boxplot(aes(fill=method)) +
  scale_fill_manual(values = pal2[m]) + 
  scale_y_continuous(limits=c(0.2,1.05)) +
  theme_bw() + xlab("") + ylab("AUROC") +
  theme(legend.position ="none",
        axis.text.x = element_text(angle = 45,hjust = 1),
        panel.grid.major.x = element_blank(),
        axis.text = element_text(size=14)) +
  ggtitle(m) +
  stat_summary(fun = mean, color="white",geom = "point", shape = 18, size = 3,show.legend = FALSE) +
  stat_pvalue_manual(sub_stats,label="sig")
ggsave("./figures/rpart2_with_stats.png",width = 5,height=4,units="in")

```
:::
:::

### SVM Radial

::: {.row}
::: {.col-md-6}
```{r svmRadial_table,echo=FALSE}
t_table %>%
  select(level,svmRadial) %>% 
  mutate(svmRadial=round(svmRadial,digits = 3)) %>% 
  rename("Median AUC"=svmRadial,"Level"=level) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position="center")
```
:::

::: {.col-md-6}
```{r svmRadial_plot,echo=F,message=F}
## svmRadial Model Performance
m <- "SVM Radial"

sub_df <- auc_df %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv"),
                       labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(method==m & auc_type=="test_AUC")

sub_stats <- p.table.model %>% 
   mutate(level1=factor(level1,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
          level2=factor(level2,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         model=factor(model,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(model==m) %>% 
  mutate(sig=case_when(p_value >= 0.05 ~ "NS",
                       TRUE ~ "*")) %>% 
  filter(sig=="NS")

sub_stats <- sub_stats %>% 
  mutate(y.position=seq.int(0.85,1.05,length.out = nrow(sub_stats))) %>% 
  rename(group1=level1,group2=level2) 

ggplot(sub_df,aes(x=level,y=AUC)) + 
  geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
  geom_boxplot(aes(fill=method)) +
  scale_fill_manual(values = pal2[m]) + 
  scale_y_continuous(limits=c(0.2,1.05)) +
  theme_bw() + xlab("") + ylab("AUROC") +
  theme(legend.position ="none",
        axis.text.x = element_text(angle = 45,hjust = 1),
        panel.grid.major.x = element_blank(),
        axis.text = element_text(size=14)) +
  ggtitle(m) +
  stat_summary(fun = mean, color="white",geom = "point", shape = 18, size = 3,show.legend = FALSE) +
  stat_pvalue_manual(sub_stats,label="sig")
ggsave("./figures/svmRadial_with_stats.png",width = 5,height=4,units="in")

```
:::
:::

### XGBTree

::: {.row}
::: {.col-md-6}
```{r xgbTree_table,echo=FALSE}
t_table %>%
  select(level,xgbTree) %>% 
  mutate(xgbTree=round(xgbTree,digits = 3)) %>% 
  rename("Median AUC"=xgbTree,"Level"=level) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position="center")
```
:::

::: {.col-md-6}
```{r xgbTree_plot,echo=F,message=F}
## XGBoost Model Performance
m <- "XGBoost"

sub_df <- auc_df %>% 
  mutate(level=factor(level,levels=c("phylum","class","order","family","genus","otu","asv"),
                       labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         method=factor(method,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(method==m & auc_type=="test_AUC")

sub_stats <- p.table.model %>% 
   mutate(level1=factor(level1,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
          level2=factor(level2,levels=c("phylum","class","order","family","genus","otu","asv"),
                            labels=c("Phylum","Class","Order","Family","Genus","OTU","ASV")),
         model=factor(model,levels=c("rf","glmnet","xgbTree","svmRadial","rpart2"),
                       labels=c("Random Forest","Logistic Regression","XGBoost","SVM Radial","Decision Tree"))) %>% 
  filter(model==m) %>% 
  mutate(sig=case_when(p_value >= 0.05 ~ "NS",
                       TRUE ~ "*")) %>% 
  filter(sig=="NS")

sub_stats <- sub_stats %>% 
  mutate(y.position=seq.int(0.85,1.05,length.out = nrow(sub_stats))) %>% 
  rename(group1=level1,group2=level2) 

ggplot(sub_df,aes(x=level,y=AUC)) + 
  geom_hline(yintercept = 0.5,color="grey",lty="dashed") +
  geom_boxplot(aes(fill=method)) +
  scale_fill_manual(values = pal2[m]) + 
  scale_y_continuous(limits=c(0.2,1.05)) +
  theme_bw() + xlab("") + ylab("AUROC") +
  theme(legend.position ="none",
        axis.text.x = element_text(angle = 45,hjust = 1),
        panel.grid.major.x = element_blank(),
        axis.text = element_text(size=14)) +
  ggtitle(m) +
  stat_summary(fun = mean, color="white",geom = "point", shape = 18, size = 3,show.legend = FALSE) +
  stat_pvalue_manual(sub_stats,label="sig")
ggsave("./figures/xgbTree_with_stats.png",width = 5,height=4,units="in")

```
:::
:::

## Feature Importance {#feature-importance}

The mikropml packages includes an option for finding [feature importance](http://www.schlosslab.org/mikropml/reference/get_feature_importance.html) using a permutation method. This significantly increases the time to run the models. The function permutes each model feature (e.g. genus) and recalculates the AUC with that feature permuted. The outputs are the permuted AUC value and the difference between this AUC value and the actual AUC value. Larger positive differences can be interpreted as being more important since the AUC value is smaller when this feature is permuted.

The importance values are all from the Random Forest model.

```{r imp_plots}
imp_plots <- list()
m="rf"
for(l in levels){
  test <- read_csv(paste0("../data/process/importance-",l,"-",m,".csv"),
                   col_types = c(perf_metric = col_double(),
                                 perf_metric_diff = col_double(),
                                 seed = col_double(),
                                 .default = col_character())) %>% 
    mutate(level := !!l)
  test_results <- read_csv(paste0("../data/process/combined-",l,"-",m,".csv"),
                           col_types = c(method = col_character(), .default = col_double())) %>% 
    mutate(level := !!l)

  test_tax <- read_tsv(paste0("../data/",l,"/crc.taxonomy"),
                   col_types = c(Size = col_double(),
                                 .default = col_character())) %>%
    mutate(level := !!l)
  
  test_merge <- test %>%
    select(perf_metric,perf_metric_diff,names,method,seed,level) %>% 
    rename(AUC=perf_metric,OTU=names,AUC_diff=perf_metric_diff) %>% 
    inner_join(test_tax,by=c("level","OTU")) %>% 
    mutate(name=paste0(Taxonomy," (",OTU,")"))

  test_quartiles <- quantile(pull(test_results,AUC))
  names(test_quartiles) <- c("q0","q1","q2","q3","q4")

  test_median <- median(pull(test_results,AUC))
  
  if(l %in% c("otu","asv")){
    imp_plots[[paste0(m,"-",l,"-1")]] <- test_merge %>% 
      mutate(OTU=reorder(OTU,desc(AUC),.fun="median")) %>% 
      ggplot(aes(x=AUC,y=OTU)) + 
        geom_point(alpha=0.5,color="lightblue") +
        stat_summary(fun = mean,geom = "point", shape = 18, size = 3,aes(color="Mean")) +
        stat_summary(fun = median,geom = "point", shape = 18, size = 3,aes(color="Median")) +
        scale_color_manual(name="",values=c("red","green")) +
        theme_bw() +
        theme(legend.position = "bottom",
              axis.text.y = element_blank()) +
        geom_vline(xintercept = test_quartiles["q1"]) +
        geom_vline(xintercept = test_quartiles["q3"]) + 
        geom_vline(xintercept = test_median,lty="dashed") +
        ggtitle(paste0(m,"-",l,": AUC ordered")) +
        xlab("Permuted AUC") + ylab("Feature")
    #ggsave(paste0("./data/analysis/exploratory3/importance_metric_",m,"_",l,".png"))
  
  imp_plots[[paste0(m,"-",l,"-2")]] <- test_merge %>% 
    mutate(OTU=reorder(OTU,AUC_diff,.fun="median")) %>% 
    ggplot(aes(x=AUC_diff,y=OTU)) + 
      geom_point(alpha=0.5,color="lightblue") +
      stat_summary(fun = mean,geom = "point", shape = 18, size = 3,aes(color="Mean")) +
      stat_summary(fun = median,geom = "point", shape = 18, size = 3,aes(color="Median")) +
      scale_color_manual(name="",values=c("red","green")) +
      geom_vline(xintercept = 0,lty="dashed",color="black") +
      theme_bw() +
      theme(legend.position = "bottom",
            axis.text.y = element_blank()) +
      ggtitle(paste0(m,"-",l,": AUC difference sorted")) +
      ylab("Feature") + xlab("AUC Difference (actual - permuted)")
    #ggsave(paste0("./data/analysis/exploratory3/importance_diff_",m,"_",l,".png"))

  }else{
    
    imp_plots[[paste0(m,"-",l,"-1")]] <- test_merge %>% 
      mutate(name=reorder(name,desc(AUC),.fun="median")) %>% 
      ggplot(aes(x=AUC,y=name)) + 
        geom_point(alpha=0.5,color="lightblue") +
        stat_summary(fun = mean,geom = "point", shape = 18, size = 3,aes(color="Mean")) +
        stat_summary(fun = median,geom = "point", shape = 18, size = 3,aes(color="Median")) +
        scale_color_manual(name="",values=c("red","green")) +
        theme_bw() +
        theme(legend.position = "bottom") +
        geom_vline(xintercept = test_quartiles["q1"]) +
        geom_vline(xintercept = test_quartiles["q3"]) + 
        geom_vline(xintercept = test_median,lty="dashed") +
        ggtitle(paste0(m,"-",l,": AUC ordered")) +
        xlab("Permuted AUC") + ylab("Feature")
    #ggsave(paste0("./data/analysis/exploratory3/importance_metric_",m,"_",l,".png"))

    imp_plots[[paste0(m,"-",l,"-2")]] <- test_merge %>% 
      mutate(name=reorder(name,AUC_diff,.fun="median")) %>% 
      ggplot(aes(x=AUC_diff,y=name)) + 
        geom_point(alpha=0.5,color="lightblue") +
        stat_summary(fun = mean,geom = "point", shape = 18, size = 3,aes(color="Mean")) +
        stat_summary(fun = median,geom = "point", shape = 18, size = 3,aes(color="Median")) +
        scale_color_manual(name="",values=c("red","green")) +
        geom_vline(xintercept = 0,lty="dashed",color="black") +
        theme_bw() +
        theme(legend.position = "bottom") +
        ggtitle(paste0(m,"-",l,": AUC difference sorted")) +
        ylab("Feature") + xlab("AUC Difference (actual - permuted)")
    #ggsave(paste0("./data/analysis/exploratory3/importance_diff_",m,"_",l,".png"))

  }
}


```

```{r rf_importance_plots,echo=F,message=F,fig.show="hold",out.width="50%",include=FALSE}
imp_plots[["rf-phylum-1"]]
imp_plots[["rf-phylum-2"]]

imp_plots[["rf-class-1"]]
imp_plots[["rf-class-2"]]

imp_plots[["rf-order-1"]]
imp_plots[["rf-order-2"]]

imp_plots[["rf-family-1"]]
imp_plots[["rf-family-2"]]

imp_plots[["rf-genus-1"]]
imp_plots[["rf-genus-2"]]

```

### Top 10 Important features

```{r importance_rank}

rf_imp <- read_csv("../data/process/importance-phylum-rf.csv",
                   col_types = c(perf_metric = col_double(),
                                 perf_metric_diff = col_double(),
                                 seed = col_double(),
                                 .default = col_character())) %>%
  mutate(level="phylum") %>%
  bind_rows(read_csv("../data/process/importance-class-rf.csv",
                   col_types = c(perf_metric = col_double(),
                                 perf_metric_diff = col_double(),
                                 seed = col_double(),
                                 .default = col_character())) %>%
    mutate(level="class")) %>%
  bind_rows(read_csv("../data/process/importance-order-rf.csv",
                   col_types = c(perf_metric = col_double(),
                                 perf_metric_diff = col_double(),
                                 seed = col_double(),
                                 .default = col_character())) %>%
    mutate(level="order")) %>%
  bind_rows(read_csv("../data/process/importance-family-rf.csv",
                   col_types = c(perf_metric = col_double(),
                                 perf_metric_diff = col_double(),
                                 seed = col_double(),
                                 .default = col_character())) %>%
    mutate(level="family")) %>%
  bind_rows(read_csv("../data/process/importance-genus-rf.csv",
                   col_types = c(perf_metric = col_double(),
                                 perf_metric_diff = col_double(),
                                 seed = col_double(),
                                 .default = col_character())) %>%
    mutate(level="genus")) %>%
  bind_rows(read_csv("../data/process/importance-otu-rf.csv",
                   col_types = c(perf_metric = col_double(),
                                 perf_metric_diff = col_double(),
                                 seed = col_double(),
                                 .default = col_character())) %>%
    mutate(level="otu")) %>% 
  bind_rows(read_csv("../data/process/importance-asv-rf.csv",
                   col_types = c(perf_metric = col_double(),
                                 perf_metric_diff = col_double(),
                                 seed = col_double(),
                                 .default = col_character())) %>%
    mutate(level="asv"))

rf_tax <- read_tsv("../data/phylum/crc.taxonomy",
                   col_types = c(Size = col_double(),
                                 .default = col_character())) %>%
  mutate(level="phylum") %>%
  bind_rows(read_tsv("../data/class/crc.taxonomy",
                   col_types = c(Size = col_double(),
                                 .default = col_character())) %>%
    mutate(level="class")) %>%
  bind_rows(read_tsv("../data/order/crc.taxonomy",
                   col_types = c(Size = col_double(),
                                 .default = col_character())) %>%
    mutate(level="order")) %>%
  bind_rows(read_tsv("../data/family/crc.taxonomy",
                   col_types = c(Size = col_double(),
                                 .default = col_character())) %>%
    mutate(level="family")) %>%
  bind_rows(read_tsv("../data/genus/crc.taxonomy",
                   col_types = c(Size = col_double(),
                                 .default = col_character())) %>%
    mutate(level="genus")) %>%
  bind_rows(read_tsv("../data/otu/crc.taxonomy",
                   col_types = c(Size = col_double(),
                                 .default = col_character())) %>%
    mutate(level="otu")) %>% 
  bind_rows(read_tsv("../data/asv//crc.taxonomy",
                   col_types = c(Size = col_double(),
                                 .default = col_character())) %>%
    mutate(level="asv"))

rf_imp_tax <- rf_imp %>%
  select(perf_metric,perf_metric_diff,names,method,seed,level) %>%
  rename(AUC=perf_metric,OTU=names,AUC_diff=perf_metric_diff) %>%
  inner_join(rf_tax,by=c("level","OTU"))

rank_tax <- function(data,tax){
  sub_data <- data %>%
    filter(level==tax) %>%
    group_by(level,Taxonomy,OTU) %>% 
    summarise(mean_AUC_diff = median(AUC_diff)) %>% 
    ungroup() %>% 
    arrange(desc(mean_AUC_diff)) %>% 
    mutate(rank=seq(1,nrow(.)))
  
  return(sub_data)
}

ranked_tax <- bind_rows(rank_tax(rf_imp_tax,"phylum"),
                        rank_tax(rf_imp_tax,"class"),
                        rank_tax(rf_imp_tax,"order"),
                        rank_tax(rf_imp_tax,"family"),
                        rank_tax(rf_imp_tax,"genus"),
                        rank_tax(rf_imp_tax,"otu"),
                        rank_tax(rf_imp_tax,"asv"))

top_10_tax <- ranked_tax %>% 
  filter(rank <= 10)

top_10_tax_table <- ranked_tax %>% 
  filter(rank <= 10) %>% 
  mutate(Taxonomy=case_when(level=="otu" ~ sapply(strsplit(Taxonomy,"();"), `[`, 6),
                            level=="asv" ~ sapply(strsplit(Taxonomy,"();"), `[`, 6),
                            TRUE ~ Taxonomy)) %>% 
  mutate(Taxonomy=sapply(strsplit(Taxonomy,"\\("), `[`, 1)) %>% 
  mutate(Taxonomy=paste0(Taxonomy," (",OTU,")"))  %>% 
  select(level,Taxonomy,rank) %>% 
  pivot_wider(names_from = level,values_from = Taxonomy) 
colnames(top_10_tax_table) <- c("Rank","Phylum","Class","Order","Family","Genus","OTU","ASV")
  
# ranked_tax %>% 
#   filter(rank <= 10) %>% 
#   mutate(Taxonomy=case_when(level=="otu" ~ sapply(strsplit(Taxonomy,"();"), `[`, 6),
#                             level=="asv" ~ sapply(strsplit(Taxonomy,"();"), `[`, 6),
#                             TRUE ~ Taxonomy)) %>% 
#   mutate(Taxonomy=sapply(strsplit(Taxonomy,"\\("), `[`, 1)) %>% 
#   mutate(Taxonomy=paste0(Taxonomy," (",OTU,")"))
  
kable(top_10_tax_table,format="html",booktabs=T,align="clllllll",
      col.names = c("Rank",levels_names)) %>% 
   kable_material(c("hover","condensed"))


### EXAMPLE plot
library(glue)
library(ggtext)

# data <- tibble(bactname = c("Staphylococcaceae", "Moraxella", "Streptococcus", "Acinetobacter"),
#                OTUname = c("OTU 1", "OTU 2", "OTU 3", "OTU 4"),
#                value = c(-0.5, 0.5, 2, 3))
# ranked_tax %>% 
#   filter(rank <= 10) %>% 
#   mutate(Taxonomy=case_when(level=="otu" ~ sapply(strsplit(Taxonomy,"();"), `[`, 6),
#                             level=="asv" ~ sapply(strsplit(Taxonomy,"();"), `[`, 6),
#                             TRUE ~ Taxonomy)) %>% 
#   mutate(Taxonomy=sapply(strsplit(Taxonomy,"\\("), `[`, 1)) %>% 
#   mutate(name = glue("<i>{Taxonomy}</i> ({OTU})")) %>% 
#   ggplot(aes(mean_AUC_diff,name)) +
#     geom_col(alpha = 0.5) + 
#     scale_fill_identity() +
#     theme(
#       axis.text.y = element_markdown(),
#       plot.caption = element_markdown(lineheight = 1.2))
# 
# data %>% mutate(
#   name = glue("<i>{bactname}</i> ({OTUname})"),
#   name = fct_reorder(name, value))  %>%
#   ggplot(aes(value, name)) + 
#     geom_col(alpha = 0.5) + 
#     scale_fill_identity() +
#     theme(
#       axis.text.y = element_markdown(),
#       plot.caption = element_markdown(lineheight = 1.2))
# 
# 
# ggplot(data = diamonds) + stat_summary(
#   mapping = aes(x = depth, y = cut),
#   fun.min = function(z) { quantile(z,0.25) },
#   fun.max = function(z) { quantile(z,0.75) },
#   fun = median)

top_10_data <- inner_join(rf_imp_tax,top_10_tax,by=c("level","OTU","Taxonomy")) %>% 
  mutate(level = factor(level,levels=levels,labels=levels_names)) %>% 
  select(level,seed,OTU,Taxonomy,AUC_diff,rank) %>% 
  mutate(Taxonomy=case_when(level=="OTU" ~ sapply(strsplit(Taxonomy,"();"), `[`, 6),
                            level=="ASV" ~ sapply(strsplit(Taxonomy,"();"), `[`, 6),
                            TRUE ~ Taxonomy)) %>% 
  mutate(Taxonomy=sapply(strsplit(Taxonomy,"\\("), `[`, 1)) %>% 
  mutate(Taxonomy=gsub("_"," ",Taxonomy)) %>% 
  mutate(Taxonomy=gsub("unclassified","unclass.",Taxonomy)) %>% 
  mutate(name = glue("<i>{Taxonomy}</i> ({OTU})")) 

plot_top_imp <- function(top_data,tax_level){
  top_data %>% 
    filter(level == tax_level) %>% 
    arrange(rank) %>% 
    ggplot(aes(x=AUC_diff,y=reorder(name,desc(rank)))) +
      #geom_jitter(color=colors2[tax_level],fill=alpha(colors2[tax_level],0.6)) +
      stat_summary(fun.data=median_hilow, fun.args=0.5, geom="pointrange", color=colors2[tax_level]) +
      theme_bw() +
      theme(axis.title.y = element_blank(),
        axis.text.y = element_markdown(),
        plot.caption = element_markdown(lineheight = 1.2)) +
      ggtitle(tax_level) +
      xlab("Decrease in AUC")
}

plotlist <- list()
plotlist[[1]] <- plot_top_imp(top_10_data,"Phylum")
plotlist[[2]] <- plot_top_imp(top_10_data,"Class")
plotlist[[3]] <- plot_top_imp(top_10_data,"Order")
plotlist[[4]] <- plot_top_imp(top_10_data,"Family")
plotlist[[5]] <- plot_top_imp(top_10_data,"Genus")
plotlist[[6]] <- plot_top_imp(top_10_data,"OTU")
plotlist[[7]] <- plot_top_imp(top_10_data,"ASV")

plot_grid(plotlist = plotlist,ncol = 2,align = "v")
ggsave("./figures/top10_imp.png",height = 10)


# gp1<- ggplot_gtable(ggplot_build(plotlist[[1]]))
# gp2<- ggplot_gtable(ggplot_build(plotlist[[2]]))
# gp3<- ggplot_gtable(ggplot_build(plotlist[[3]]))
# gp4<- ggplot_gtable(ggplot_build(plotlist[[4]]))
# gp5<- ggplot_gtable(ggplot_build(plotlist[[5]]))
# gp6<- ggplot_gtable(ggplot_build(plotlist[[6]]))
# gp7<- ggplot_gtable(ggplot_build(plotlist[[7]]))
# 
# maxWidth = unit.pmax(gp1$widths[2:3], 
#                      gp2$widths[2:3],
#                      gp3$widths[2:3],
#                      gp4$widths[2:3],
#                      gp5$widths[2:3],
#                      gp6$widths[2:3],
#                      gp7$widths[2:3])
# 
# gp1$widths[2:3] <- maxWidth
# gp2$widths[2:3] <- maxWidth
# gp3$widths[2:3] <- maxWidth
# gp4$widths[2:3] <- maxWidth
# gp5$widths[2:3] <- maxWidth
# gp6$widths[2:3] <- maxWidth
# gp7$widths[2:3] <- maxWidth
# 
# grid.arrange(gp1,gp2,gp3,gp4,gp5,gp6,gp7)
# ggsave("./figures/top10_imp.png")
# 
# ggarrange(plotlist = plotlist,ncol=2)

# grid.arrange(plotlist[[1]],
#              plotlist[[2]],
#              plotlist[[3]],
#              plotlist[[4]],
#              plotlist[[5]],
#              plotlist[[6]],
#              plotlist[[7]])

```
## Correlated Features
Highly correlated model features should be collapsed (i.e. permuted together) when quantifying permutation importance.
First checking if any features are correlated in this dataset.

```{r corr_feats}


get_annotated_corr <- function(tax_level){
  l_cor <- read_csv(paste0("../analysis/taxa_correlations_",tax_level,".csv"),
                    col_types = cols(.default = col_character(),
                                     corr = col_double(), 
                                     proc_corr = col_double())) 
  l_tax <- read_tsv(paste0("../data/",tax_level,"/crc.taxonomy"),
                     col_types = c(Size = col_double(),
                                   .default = col_character())) %>%
    select(-Size)
  
  merge <- inner_join(l_cor,l_tax,by=c("taxa1"="OTU")) %>% 
    rename(taxa1_name=Taxonomy) %>% 
    inner_join(.,l_tax,by=c("taxa2"="OTU")) %>% 
    rename(taxa2_name=Taxonomy) %>% 
    select(level,taxa1,taxa2,taxa1_name,taxa2_name,proc_corr) %>% 
    rename(corr=proc_corr)
  
  return(merge)
}

annotated_feature_correlations <- get_annotated_corr("phylum") %>% 
  bind_rows(get_annotated_corr("class")) %>% 
  bind_rows(get_annotated_corr("order")) %>% 
  bind_rows(get_annotated_corr("family")) %>% 
  bind_rows(get_annotated_corr("genus")) %>% 
  bind_rows(get_annotated_corr("otu")) %>% 
  bind_rows(get_annotated_corr("asv"))
  

maxmin_corr <- annotated_feature_correlations %>% 
  mutate(level=factor(level,levels=levels)) %>% 
  group_by(level) %>% 
  summarise(max_corr = max(corr),
            min_corr = min(corr))

corr90 <- annotated_feature_correlations %>% 
  filter(abs(corr) > 0.9) 

annotated_feature_correlations %>% 
  filter(level == "genus") %>% 
  filter(abs(corr) > 0.85)
  
# View(annotated_feature_correlations %>% 
#        filter(level == "otu") %>%
#        filter(abs(corr) < 0.9) %>% 
#        filter(abs(corr) > 0.8))

#c("Otu00229","Otu00328","Otu00331", "Otu00361", "Otu00413", "Otu00449")
```

## Importance - threshold 0.9 {#importance90}

```{r importance90,echo=F}



```

## Prevalence {#prevalence}

```{r prevalence,echo=F,message=F}

prevalence <- read_csv("../analysis/prevalence_by_level.csv")

prevalence$level <- factor(prevalence$level,levels=levels)

tax_count <- prevalence %>% 
  filter(kept==1) %>% 
  group_by(level) %>% 
  mutate(numOTU = n_distinct(name)) %>% 
  select(level,numOTU) %>% 
  distinct()

pct_bins <- NULL
level_nOTU <- NULL
for(l in levels){
  sub_data <- prevalence %>% 
    filter(level==l,kept==1)
  hist <- hist(sub_data$total_prevalence,breaks = seq(0,1,0.1),plot=FALSE)

  nOTU <- sub_data %>%
    select(name) %>% 
    n_distinct()
  
  level_nOTU <- bind_rows(level_nOTU,
                          data.frame(l,nOTU))
  
  pct_bins <- pct_bins %>% 
    bind_rows(data.frame(level=l,
                         prev=hist$breaks[-1],
                         count=hist$counts,
                         pct=hist$counts/nOTU))
}

level_nOTU <- level_nOTU %>% 
  mutate(level_name = levels_names) 
labs <- paste0(level_nOTU$level_name," (",level_nOTU$nOTU,")")
pal <- colors2
names(pal) <- labs
  
pct_bins %>%
  mutate(level=factor(level,levels=levels,labels=labs)) %>% 
  ggplot(aes(x=prev,y=pct,fill=level)) +
    geom_bar(stat = "identity") +
    facet_wrap(~level,ncol=2) +
    scale_y_continuous(expand=c(0,0),limits=c(0,0.8),labels = scales::percent_format()) +
    scale_x_continuous(expand=c(0,0),breaks = seq(0,1,0.1)) +
    xlab("Prevalence in Samples") +
    ylab("Percent of Taxa") +
    theme_bw() +
    theme(legend.position = "none",
          axis.text = element_text(size=12),
          axis.title = element_text(size=14),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank()) +
  geom_text(aes(label = paste0((round(pct,digits=2)*100),"%")),nudge_y=0.08) +
  scale_fill_manual(values=pal)
ggsave("./figures/bin_prevalence.png")
```

## Prevalence VS Difference in Median Abundance {#prev-diff-abund}

Taxa prevalence across all samples compared to the difference in median relative abundance between cancer and normal samples. Top 10 taxa based on importance rank are red, rank 11-20 are blue, and the rest are grey.

```{r prev_abund,echo=F}

library(plotly)

metadata <- read_csv("../data/metadata/metadata.csv",
                     col_types = cols(.default = col_double(),
                                      sample = col_character(),
                                      Dx_Bin = col_character(),
                                      dx = col_character(),
                                      Height = col_character(),
                                      Gender = col_character(),
                                      Weight = col_character(),
                                      BMI = col_character()))

get_abund_prev <- function(tax_level,file,metadata,prev){
  sub_meta <- metadata %>%
    mutate(dx=case_when(Dx_Bin =="Adenoma" ~ "normal",
                        Dx_Bin== "Normal" ~ "normal",
                        Dx_Bin== "High Risk Normal" ~ "normal",
                        Dx_Bin== "adv Adenoma" ~ "cancer",
                        Dx_Bin== "Cancer" ~ "cancer")) %>% 
    select(sample,dx) %>% 
    drop_na() %>% 
    rename(Group=sample)
  sub_prev <- prev %>% 
    filter(level == tax_level & kept == 1) %>% 
    select(name,total_prevalence)
  abund <- as.data.frame(fread(file)) %>% 
    mutate(Group=as.character(Group)) %>% 
    select(-label,-numOtus)
    
  abund_prev <- inner_join(abund,sub_meta,by="Group") %>% 
    select(Group,dx,everything()) %>% 
    pivot_longer(cols=starts_with("Otu"),names_to = "name",values_to = "relabun") %>% 
    group_by(name,dx) %>% 
    summarize(median_relabund = median(relabun)) %>% 
    ungroup() %>% 
    pivot_wider(id_cols = "name",names_from="dx",values_from = "median_relabund") %>% 
    mutate(median_diff = normal - cancer) %>% 
    inner_join(.,sub_prev,by="name")
  
  return(abund_prev)
  
}

plot_abund_prev <- function(abund_prev,ranked_tax,tax_level){
  level_ranked_tax <- ranked_tax %>% 
    filter(level == tax_level) %>% 
    rename(name=OTU) %>% 
    select(-level,-mean_AUC_diff)
  
  ##non-interactive plot
  
  # plot <- abund_prev %>% 
  #   inner_join(.,level_ranked_tax,by="name") %>% 
  #   mutate(rank_category = case_when(rank <= 10 ~ "top10",
  #                                    rank <= 20 ~ "top20",
  #                                    TRUE ~ "other")) %>% 
  #   ggplot(aes(x=prevalence,y=median_diff,color=rank_category)) +
  #     geom_point(alpha=0.3,size=3) +
  #     theme_bw() +
  #     #theme(legend.position = "none") +
  #     xlab("Prevalence") +
  #     scale_color_manual(name="Rank",
  #                        values=c("red","cornflowerblue","grey"),
  #                        breaks=c("top10","top20","other")) +
  #     ylab("Difference in median relative abundance (cancer-normal)") +
  #     ggtitle(tax_level)
  

  # interactive plot
  
  data <- abund_prev %>% 
    inner_join(.,level_ranked_tax,by="name") %>% 
    mutate(rank_category = case_when(rank <= 10 ~ "top10",
                                     rank <= 20 ~ "top20",
                                     TRUE ~ "other"))

  if(tax_level %in% c("otu","asv")){
    data <- data %>% 
      mutate(Taxonomy=sapply(strsplit(Taxonomy,"();"), `[`, 6)) %>% 
      mutate(Taxonomy=sapply(strsplit(Taxonomy,"\\("), `[`, 1))
  }
  # plot <- ggplot(data,aes(x=prevalence,y=median_diff,color=rank_category)) +
  #   geom_point(alpha=0.3,size=3) +
  #   theme_bw() +
  #   #theme(legend.position = "none") +
  #   xlab("Prevalence") +
  #   scale_color_manual(name="Rank",
  #                      values=c("red","cornflowerblue","grey"),
  #                      breaks=c("top10","top20","other")) +
  #   ylab("Difference in median relative abundance (cancer-normal)") +
  #   ggtitle(tax_level)
  # ggplotly(plot) %>% 
  #   style(hoverinfo = "name")
  # return(plot)
  
  plotly <- plot_ly(data) %>% 
    add_trace(type="scatter",
              mode="markers",
              x= ~total_prevalence,
              y = ~median_diff, 
              color= ~factor(rank_category,levels=c("top10","top20","other")),
              hoverinfo="text",
              text = ~paste("</br>",Taxonomy,"(",name,")",
                            "</br> Prevalence: ",round(total_prevalence,digits=2),
                            "</br> Diff median relabund: ",round(median_diff,digits=5)),
              colors=c("red","cornflowerblue","grey"),
              opacity=0.3,
              marker = list(size = 10))
  final_plotly <- plotly %>% layout(title=tax_level,
                                    xaxis = list(title = "Overall Prevalence",autorange=TRUE,showline=TRUE), 
                                    yaxis = list(title = "Differene in median relative abundance (cancer - normal)",
                                                 autorange=TRUE,showline=TRUE,zerolinecolor = toRGB("grey70")))
  return(final_plotly)
}

phylum_abund_prev <- get_abund_prev("phylum","../data/phylum/crc.relabund",metadata,prevalence)
plot_abund_prev(phylum_abund_prev,ranked_tax,"phylum")

class_abund_prev <- get_abund_prev("class","../data/class/crc.relabund",metadata,prevalence)
plot_abund_prev(class_abund_prev,ranked_tax,"class")

order_abund_prev <- get_abund_prev("order","../data/order/crc.relabund",metadata,prevalence)
plot_abund_prev(order_abund_prev,ranked_tax,"order")

family_abund_prev <- get_abund_prev("family","../data/family/crc.relabund",metadata,prevalence)
plot_abund_prev(family_abund_prev,ranked_tax,"family")

genus_abund_prev <- get_abund_prev("genus","../data/genus/crc.relabund",metadata,prevalence)
plot_abund_prev(genus_abund_prev,ranked_tax,"genus")

otu_abund_prev <- get_abund_prev("otu","../data/otu/crc.relabund",metadata,prevalence)
plot_abund_prev(otu_abund_prev,ranked_tax,"otu")

asv_abund_prev <- get_abund_prev("asv","../data/asv/crc.relabund",metadata,prevalence)
plot_abund_prev(asv_abund_prev,ranked_tax,"asv")

```


## Prevalence by Group {#prevalence-by-group}
```{r prev_group,echo=F}
plot_prev <- function(prevalence,ranked_tax,tax_level){
  level_ranked_tax <- ranked_tax %>% 
    filter(level == tax_level) %>% 
    rename(name=OTU) %>% 
    select(-level,-mean_AUC_diff)
  
  data <- prevalence %>% 
    filter(level == tax_level) %>% 
    inner_join(.,level_ranked_tax,by="name") %>% 
    mutate(rank_category = case_when(rank <= 10 ~ "top10",
                                     rank <= 20 ~ "top20",
                                     TRUE ~ "other"))

  if(tax_level %in% c("otu","asv")){
    data <- data %>% 
      mutate(Taxonomy=sapply(strsplit(Taxonomy,"();"), `[`, 6)) %>% 
      mutate(Taxonomy=sapply(strsplit(Taxonomy,"\\("), `[`, 1))
  }
 
  d <- data.frame(x=seq(0,1,0.1),y=seq(0,1,0.1))
  
  plotly <- plot_ly(data) %>% 
    add_trace(type="scatter",
              mode="markers",
              x= ~normal_prevalence,
              y = ~srn_prevalence, 
              color= ~factor(rank_category,levels=c("top10","top20","other")),
              hoverinfo="text",
              text = ~paste("</br>",Taxonomy,"(",name,")",
                            "</br> SRN Prevalence: ",round(srn_prevalence,digits=2),
                            "</br> Normal Prevalence: ",round(normal_prevalence,digits=2)),
              colors=c("red","cornflowerblue","grey"),
              opacity=0.3,
              marker = list(size = 10))
  final_plotly <- plotly %>% layout(title=tax_level,
                                    xaxis = list(title = "Prevalence in Normal Samples",range=c(0,1.05),showline=TRUE,
                                                 zerolinecolor = toRGB("grey70")), 
                                    yaxis = list(title = "Prevalence in SRN Samples",range=c(0,1.05),showline=TRUE,
                                                 zerolinecolor = toRGB("grey70"))) %>% 
        add_trace(data=d,x=~x,y=~y,type="scatter",mode="lines",color=I('grey'),name="y=x line")
  return(final_plotly)
}




plot_prev(prevalence,ranked_tax,"phylum")
plot_prev(prevalence,ranked_tax,"class")
plot_prev(prevalence,ranked_tax,"order")
plot_prev(prevalence,ranked_tax,"family")
plot_prev(prevalence,ranked_tax,"genus")
plot_prev(prevalence,ranked_tax,"otu")
plot_prev(prevalence,ranked_tax,"asv")
  
```

## Median Non-Zero Relative Abundance by Group {#med-relabund-group}
```{r relabund,echo=F}
metadata <- read_csv("../data/metadata/metadata.csv",
                     col_types = cols(.default = col_double(),
                                      sample = col_character(),
                                      Dx_Bin = col_character(),
                                      dx = col_character(),
                                      Gender = col_character(),
                                      Height = col_character(),
                                      Weight = col_character(),
                                      BMI = col_character()))

get_abund <- function(tax_level,file,metadata){
  sub_meta <- metadata %>%
    mutate(dx=case_when(Dx_Bin =="Adenoma" ~ "normal",
                        Dx_Bin== "Normal" ~ "normal",
                        Dx_Bin== "High Risk Normal" ~ "normal",
                        Dx_Bin== "adv Adenoma" ~ "cancer",
                        Dx_Bin== "Cancer" ~ "cancer")) %>% 
    select(sample,dx) %>% 
    drop_na() %>% 
    rename(Group=sample)
  abund <- as.data.frame(fread(file)) %>% 
    mutate(Group=as.character(Group)) %>% 
    select(-label,-numOtus)
    
  data <- inner_join(abund,sub_meta,by="Group") %>% 
    select(Group,dx,everything()) %>% 
    pivot_longer(cols=starts_with("Otu"),names_to = "name",values_to = "relabun") %>% 
    filter(relabun > 0) %>% 
    group_by(name,dx) %>% 
    summarize(median_relabund = median(relabun)) %>% 
    ungroup() %>% 
    pivot_wider(id_cols = "name",names_from="dx",values_from = "median_relabund",values_fill = 0) 
  return(data)
}

plot_abund <- function(data,tax_level,ranked_tax){
  plot_data <- ranked_tax %>% 
    filter(level == tax_level) %>% 
    select(-mean_AUC_diff) %>% 
    rename(name=OTU) %>% 
    inner_join(.,data,by="name") %>% 
    mutate(rank_category = case_when(rank <= 10 ~ "top10",
                                     rank <= 20 ~ "top20",
                                     TRUE ~ "other"))

  if(tax_level %in% c("otu","asv")){
    plot_data <- plot_data %>% 
      mutate(Taxonomy=sapply(strsplit(Taxonomy,"();"), `[`, 6)) %>% 
      mutate(Taxonomy=sapply(strsplit(Taxonomy,"\\("), `[`, 1))
  }
  
  d <- data.frame(x=seq(0,1,0.1),y=seq(0,1,0.1))
  
  max_relabun <- max(max(plot_data$cancer),max(plot_data$normal))
  #axis_max <- round(max_relabun + 0.05,digits=1)
  axis_max <- max_relabun + 0.01
  
  plotly <- plot_ly(plot_data) %>% 
    add_trace(type="scatter",
              mode="markers",
              x= ~normal,
              y = ~cancer, 
              color= ~factor(rank_category,levels=c("top10","top20","other")),
              hoverinfo="text",
              text = ~paste("</br>",Taxonomy,"(",name,")",
                            "</br> SRN RelAbund: ",round(cancer,digits=2),
                            "</br> Normal RelAbund: ",round(normal,digits=2)),
              colors=c("red","cornflowerblue","grey"),
              opacity=0.3,
              marker = list(size = 10))
  final_plotly <- plotly %>% layout(title=tax_level,
                                    xaxis = list(title = "Median Non-Zero Relative Abundance in Normal Samples",range=c(0,axis_max),showline=TRUE,
                                                 zerolinecolor = toRGB("grey70")), 
                                    yaxis = list(title = "Median Non-Zero Relative Abundance in SRN Samples",range=c(0,axis_max),showline=TRUE,
                                                 zerolinecolor = toRGB("grey70"))) %>% 
        add_trace(data=d,x=~x,y=~y,type="scatter",mode="lines",color=I('grey'),name="y=x line")
  return(final_plotly)
}

phylum_abund <- get_abund("phylum","../data/phylum/crc.relabund",metadata)
plot_abund(phylum_abund,"phylum",ranked_tax)

class_abund <- get_abund("class","../data/class/crc.relabund",metadata)
plot_abund(class_abund,"class",ranked_tax)

order_abund <- get_abund("order","../data/order/crc.relabund",metadata)
plot_abund(order_abund,"order",ranked_tax)

family_abund <- get_abund("family","../data/family/crc.relabund",metadata)
plot_abund(family_abund,"family",ranked_tax)

genus_abund <- get_abund("genus","../data/genus/crc.relabund",metadata)
plot_abund(genus_abund,"genus",ranked_tax)

otu_abund <- get_abund("otu","../data/otu/crc.relabund",metadata)
plot_abund(otu_abund,"otu",ranked_tax)

asv_abund <- get_abund("asv","../data/asv/crc.relabund",metadata)
plot_abund(asv_abund,"asv",ranked_tax)
```

## Sensitivity at 90% Specificity {#sens-90spec}

```{r senspec,echo=F}

# tax_level <- "phylum"
# senspec <- read_csv(paste0("../data/process/senspec-",tax_level,"-rf.csv"),
#                     col_types = cols(level = col_character(),.default = col_double()))
# 
# # senspec %>% 
# #   ggplot(aes(x=threshold,y=sensitivity)) +
# #     stat_summary(fun.y=mean,
# #                  fun.ymin=function(x) mean(x) - sd(x),
# #                  fun.ymax=function(x) mean(x) + sd(x),
# #                  geom="pointrange")
# # senspec %>% 
# #   ggplot(aes(x=threshold)) +
# #     stat_summary(aes(y=sensitivity),
# #                  fun.data=median_hilow,
# #                  geom="pointrange",size=0.2,color="blue") +
# #     stat_summary(aes(y=specificity),
# #                  fun.data=median_hilow,
# #                  geom="pointrange",size=0.2,color="red")
# #     theme_bw()
#     
# get_sens_vals <- function(tax_level,spec){
#   data <-  read_csv(paste0("../data/process/senspec-",tax_level,"-rf.csv"),
#                     col_types = cols(level = col_character(),.default = col_double()))
#   filtered_data <- NULL
#   for(i in 1:100){
#     idata <- data %>% 
#       filter(seed == i) %>% 
#       mutate(specificity=round(specificity,digits=2)) %>% 
#       filter(specificity >= spec) 
#     filtered_data <- bind_rows(filtered_data,idata[1,])
#   }
#   if(nrow(filtered_data) < 100){
#     stop("missing data")
#   }
#   return(filtered_data)
# }
# 
# sens_vals <- get_sens_vals("phylum",0.9) %>% 
#   bind_rows(.,get_sens_vals("class",0.9)) %>% 
#   bind_rows(.,get_sens_vals("order",0.9)) %>% 
#   bind_rows(.,get_sens_vals("family",0.9)) %>% 
#   bind_rows(.,get_sens_vals("genus",0.9)) %>% 
#   bind_rows(.,get_sens_vals("otu",0.9)) %>% 
#   bind_rows(.,get_sens_vals("asv",0.9)) %>% 
#   mutate(level=factor(level,levels = levels,labels=levels_names))
# 
# 
# ggplot(sens_vals,aes(x=level,y=sensitivity,color=level)) +
#   geom_jitter(width=0.2,alpha=0.5) +
#   stat_summary(fun.data=median_hilow, fun.args=0.5, geom="crossbar", width=0.5, color="black") +
#   theme_bw() +
#   xlab("") + ylab("Sensitivity") +
#   theme(axis.text = element_text(size=14),
#         axis.title = element_text(size=14),
#         legend.position = "none",
#         panel.grid.major.x = element_blank()) +
#   scale_y_continuous(breaks=seq(0,1,0.1),labels = scales::percent_format(accuracy = 1)) +
#   ggtitle("Sensitivity at 90% Specificity")
# 
# ggplot(sens_vals,aes(x=level,y=sensitivity,color=level)) +
#   geom_jitter(width=0.2,alpha=0.5) +
#   stat_summary(fun.data=median_hilow, fun.args=0.5, geom="pointrange", color="black") +
#   theme_bw() +
#   xlab("") + ylab("Sensitivity") +
#   theme(axis.text = element_text(size=14),
#         axis.title = element_text(size=14),
#         legend.position = "none",
#         panel.grid.major.x = element_blank()) +
#   scale_y_continuous(breaks=seq(0,1,0.1),labels = scales::percent_format(accuracy = 1)) +
#   ggtitle("Sensitivity at 90% Specificity")

# all_senspec <- read_csv(paste0("../data/process/senspec-phylum-rf.csv"),
#                         col_types = cols(level = col_character(),.default = col_double())) %>% 
#   bind_rows(read_csv(paste0("../data/process/senspec-class-rf.csv"),
#                      col_types = cols(level = col_character(),.default = col_double()))) %>% 
#   bind_rows(read_csv(paste0("../data/process/senspec-order-rf.csv"),
#                      col_types = cols(level = col_character(),.default = col_double()))) %>% 
#   bind_rows(read_csv(paste0("../data/process/senspec-family-rf.csv"),
#                      col_types = cols(level = col_character(),.default = col_double()))) %>% 
#   bind_rows(read_csv(paste0("../data/process/senspec-genus-rf.csv"),
#                      col_types = cols(level = col_character(),.default = col_double()))) %>% 
#   bind_rows(read_csv(paste0("../data/process/senspec-otu-rf.csv"),
#                      col_types = cols(level = col_character(),.default = col_double()))) %>% 
#   bind_rows(read_csv(paste0("../data/process/senspec-asv-rf.csv"),
#                      col_types = cols(level = col_character(),.default = col_double())))
# all_senspec %>% 
#   group_by(threshold,level) %>% 
#   summarise(mean_sensitivity=mean(sensitivity),
#             sd_sensitivity=sd(sensitivity),
#             mean_specificity=mean(specificity),
#             sd_specificty=sd(specificity))
#   ggplot(aes(x=1-specificity,y=sensitivity,color=level)) +
#     geom_path()
  
get_level_senspec <- function(tax_level,spec_val){
  l_probs <- read_csv(paste0("../data/process/probability-",tax_level,"-rf.csv"),
                    col_types = cols( actual = col_character(),
                                      level = col_character(),
                                      .default = col_double()))

  l_info <- NULL
  aucs <- NULL
  for(i in 1:100){
    seed_probs <- l_probs %>% 
      filter(seed == i)
    
    response <- seed_probs$actual
    predictor <- seed_probs$cancer
    
    # make roc curve to get sensitivity/specificities
    seed_roc <- roc(response,predictor,levels=c("normal","cancer"),direction="<")
    #plot(seed_roc)
    
    # record sensitivity/specificity values
    # round specificities so we can find desired spec val
    seed_spec <- round(seed_roc$specificities,digits=2)
    seed_sens <- seed_roc$sensitivities
    
    # make a table of all values
    seed_info <- tibble(seed=i,
                        sensitivity=seed_sens,
                        specificity=seed_spec)
    
    # get just sensitivity at desired specificity
    spec_info <- seed_info %>%
      filter(specificity == spec_val)

    #check if there are no values at the cutoff
    if(nrow(spec_info) == 0){
      above <- seed_info %>%
        filter(specificity > spec_val) %>%
        top_n(-1,wt=specificity) %>%
        top_n(1,wt=sensitivity)

      below <- seed_info %>%
        filter(specificity < spec_val) %>%
        top_n(1,wt=specificity) %>%
        top_n(-1,wt=sensitivity)
      
      if(above$sensitivity == below$sensitivity){
        # since the sensitivity above and below the target are the same,
        # then assign the same sensitivity value to the target
        spec_info <- tibble(seed=i,
                            sensitivity=above$sensitivity,
                            specificity=spec_val)

      }else{
        #find the slope of the line between the two points and the y-intercept
        slope = ((above$sensitivity-below$sensitivity)/(above$specificity-below$specificity))
        y_int = below$sensitivity - slope*below$specificity

        # calculate the sensitivity for the target between the points 
        # based on the calculated slope and intercept
        sens_val = slope*spec_val + y_int

        spec_info <- tibble(seed=i,
                            sensitivity=sens_val,
                            specificity=spec_val)
      }
    }else{
      # get max sensitivity value for the cutoff
      sub_info <- spec_info %>% 
        top_n(n=1,wt=sensitivity)
    }
    
    l_info <- bind_rows(l_info,sub_info) %>% 
      mutate(level = tax_level)
    
  }
  
  return(l_info)
  
}

library(mosaic)
perm_p_value_senspec <- function(data, level1, level2){
  # subset results to select AUC and condition columns and
  # filter to only the two conditions of interest
  test_subsample <- data %>%
    mutate(level = as.character(level)) %>% 
    select(level,sensitivity) %>%
    filter((level == level1 | level == level2))
  # quantify the absolute value of the difference in mean AUC between the two conditions (observed difference)
  obs <- abs(diff(mosaic::mean(sensitivity ~ level, data = test_subsample)))
  # use mosaic to shuffle condition labels and calculate difference in mean AUC - repeat 10,000 times
  null <- do(10000) * diff(mosaic::mean(sensitivity ~ shuffle(level), data = test_subsample))
  n <- length(null[,1]) #number of shuffled calculations
  # r = #replications at least as extreme as observed effect
  r <- sum(abs(null[,1]) >= obs) #count number of shuffled differences as big or bigger than observed difference
  # compute Monte Carlo p-value with correction (Davison & Hinkley, 1997)
  p.value=(r+1)/(n+1)
  return(p.value)
}


all_sensspec90<- get_level_senspec("phylum",0.9) %>% 
  bind_rows(get_level_senspec("class",0.9)) %>% 
  bind_rows(get_level_senspec("order",0.9)) %>% 
  bind_rows(get_level_senspec("family",0.9)) %>% 
  bind_rows(get_level_senspec("genus",0.9)) %>% 
  bind_rows(get_level_senspec("otu",0.9)) %>% 
  bind_rows(get_level_senspec("asv",0.9)) %>% 
  mutate(level = factor(level,levels=rev(levels),labels=rev(levels_names)))

senspec_pvals <- expand_grid(x=1:length(levels_names),
                                 y=1:length(levels_names),
                                 ) %>%
  filter(x < y) %>%
  mutate(level1 = levels_names[x], 
         level2 = levels_names[y]) %>%
  select(-x, -y) %>%
  group_by(level1, level2) %>%
  summarize(p_value = perm_p_value_senspec(all_sensspec90,level1,level2),
            .groups="drop")
detach("package:mosaic", unload=TRUE)

#testing
# spec_val = 0.9
# vals <- tibble(y=rev(c(0.1,0.15,0.2,0.25,0.3)),
#                x=c(0.84,0.88,0.88,0.92,0.94))
# vals %>% 
#   mutate(closeness=abs(spec_val - x)) %>% 
#   filter(closeness == min(closeness))
# 
# 
# above <- vals %>%
#   filter(x > spec_val) %>%
#   top_n(-1,wt=x) %>%
#   top_n(1,wt=y)
# 
# below <- vals %>%
#   filter(x < spec_val) %>%
#   top_n(1,wt=x) %>%
#   top_n(-1,wt=y)
#       
# slope = ((above$y-below$y)/(above$x-below$x))
# y_int = below$y - slope*below$x
# 
# slope*spec_val + y_int

#interesting examples
#tax_level="class"
#i=13
#tax_level="family"
#i=89

#visuals
# plot(seed_roc)
# abline(v=below$specificity,col="grey")
# abline(v=above$specificity,col="grey")
# abline(v=spec_val,col="red")
# abline(h=sens_val,col="blue")


# ggplot(all_sensspec90,aes(x=level,y=sensitivity,color=level)) +
#   geom_jitter(width=0.2,alpha=0.5) +
#   stat_summary(fun.data=median_hilow, fun.args=0.5, geom="crossbar", width=0.5, color="black") +
#   theme_bw() +
#   xlab("") + ylab("Sensitivity") +
#   theme(axis.text = element_text(size=14),
#         axis.title = element_text(size=14),
#         legend.position = "none",
#         panel.grid.major.x = element_blank()) +
#   scale_y_continuous(breaks=seq(0,1,0.1),labels = scales::percent_format(accuracy = 1)) +
#   ggtitle("Sensitivity at 90% Specificity")

ggplot(all_sensspec90,aes(x=level,y=sensitivity,color=level)) +
  geom_jitter(width=0.2,alpha=0.5,size=2,height = 0) +
  stat_summary(fun.data=median_hilow, fun.args=0.5, geom="pointrange", color="black") +
  theme_bw() +
  xlab("") + ylab("Sensitivity") +
  theme(axis.text = element_text(size=12),
        axis.title = element_text(size=12),
        legend.position = "none",
        panel.grid.major.y = element_blank()) +
        #panel.grid.major.x = element_blank()) +
  coord_flip() +
  scale_y_continuous(breaks=seq(0,1,0.1),labels = scales::percent_format(accuracy = 1)) +
  #ggtitle("Sensitivity at 90% Specificity")
  scale_color_manual(values=rev(colors2)) + 
  annotate("text",x=levels_names,y=rep((max(all_sensspec90$sensitivity)+0.05),length(levels_names)),label=c("W","W","X","Y","Y","Y","Z")) 
ggsave("./figures/sens_90spec.png",width = 4.5,height=5,units="in")



```
  

## Averaged ROC Curve {#avg-roc}

```{r avg_roc}

# args <- data.frame(data="./data/otu/input_data_preproc.csv",
#           method="rf",
#           seed=1,
#           taxonomy="otu",
#           outcome_colname="dx",
#           outcome_value="cancer",
#           hyperparams="./data/hyperparameters/rf_hyperparameters.csv")

# for each seed, over a range of specified specificities, 
# find the sensitivities
# us ROC curve to calculate values. 
get_level_senspec_avg <- function(tax_level){
  l_probs <- read_csv(paste0("../data/process/probability-",tax_level,"-rf.csv"),
                    col_types = cols( actual = col_character(),
                                      level = col_character(),
                                      .default = col_double()))

  l_info <- NULL
  aucs <- NULL
  for(i in 1:100){
    seed_probs <- l_probs %>% 
      filter(seed == i)
      
    response <- seed_probs$actual
    predictor <- seed_probs$cancer
    
    seed_roc <- roc(response,predictor,levels=c("normal","cancer"),direction="<")
    
    seed_spec <- round(seed_roc$specificities,digits=2)
    seed_sens <- seed_roc$sensitivities
    
    #plot(seed_roc)
    
    seed_info <- tibble(seed=i,
                        sensitivity=seed_sens,
                        specificity=seed_spec)
    
    seed_auc <- tibble(seed=i,
                       auc=as.numeric(auc(seed_roc)))
    
    l_info <- bind_rows(l_info,seed_info)
    
    aucs <- bind_rows(aucs,seed_auc)
  }
  
  l_info <- l_info %>% 
    group_by(specificity) %>%
    summarise(mean_sensitivity = mean(sensitivity),
              sd_sensitivity = sd(sensitivity)) %>%
    mutate(upper_sens = mean_sensitivity + sd_sensitivity,
           lower_sens = mean_sensitivity - sd_sensitivity) %>% 
    mutate(level = tax_level,
           avg_auc = mean(aucs$auc))
  
  
  return(l_info)
  
}

all_info <- get_level_senspec_avg("phylum") %>% 
  bind_rows(get_level_senspec_avg("class")) %>% 
  bind_rows(get_level_senspec_avg("order")) %>% 
  bind_rows(get_level_senspec_avg("family")) %>% 
  bind_rows(get_level_senspec_avg("genus")) %>% 
  bind_rows(get_level_senspec_avg("otu")) %>% 
  bind_rows(get_level_senspec_avg("asv")) %>% 
  mutate(level=factor(level,levels=levels,labels=levels_names)) %>% 
  mutate(upper_sens = case_when(upper_sens > 1 ~ 1,
                                TRUE ~ upper_sens),
         lower_sens = case_when(upper_sens < 0 ~ 0,
                                TRUE ~ lower_sens))

all_info %>% 
  ggplot(aes(x=specificity,y=mean_sensitivity,
             ymin=lower_sens,ymax=upper_sens)) +
    geom_line(aes(color=level),alpha=0.7) +
    geom_ribbon(aes(fill=level),alpha=0.2) +
    coord_equal() +
    geom_abline(intercept = 1,lty="dashed",color="grey50") +
    #scale_x_continuous(expand = c(0,0),labels = scales::percent_format(accuracy = 1)) +
    scale_y_continuous(expand = c(0,0),labels = scales::percent_format(accuracy = 1)) +
    xlab("Specificity") +
    ylab("Average Sensitivity") +
    #facet_wrap(~level,ncol=3) +  
    scale_x_reverse(expand = c(0,0),labels = scales::percent_format(accuracy = 1)) +
    theme_bw() +
    theme(legend.position = "top",
          axis.text = element_text(size=11),
          axis.title = element_text(size=12),
          axis.text.x = element_text(vjust = -0.5),
          axis.title.x = element_text(vjust= -0.5)) +
    guides(color = guide_legend(nrow = 1,title=""),
           fill = guide_legend(nrow = 1,title="")) +
    scale_fill_manual(values=colors2) +
    scale_color_manual(values=colors2)
#ggsave("./figures/roc_all.png",width=6)

ggplot(all_info,aes(x=specificity*100,y=mean_sensitivity*100,
                    ymin=lower_sens*100,ymax=upper_sens*100)) +
    geom_line(aes(color=level),alpha=0.8,lwd=1) +
    geom_ribbon(aes(fill=level),alpha=0.2) +
    coord_equal() +
    geom_abline(intercept = 1,lty="dashed",color="grey50") +
    #scale_x_continuous(expand = c(0,0)) +
    scale_y_continuous(expand = c(0,0)) + #,labels = scales::percent_format(accuracy = 1)) +
    xlab("Specificity (%)") +
    ylab("Average Sensitivity (%)") +
    facet_wrap(~level,nrow=2) +  
    scale_x_reverse(expand = c(0,0)) + #,labels = scales::percent_format(accuracy = 1)) +  
    theme_bw() +
    theme(legend.position = "top",
          axis.text.x = element_text(angle = -45,vjust=0.5,hjust=0),
          axis.text = element_text(size=9),
          axis.title = element_text(size=12)) +
    guides(color = guide_legend(nrow = 1,title=""),
           fill = guide_legend(nrow = 1,title="")) +
    geom_text(aes(x = 25, y = 25, label = paste0("mean AUC\n",round(avg_auc,digits=3)))) + 
    scale_fill_manual(values=colors2) +
    scale_color_manual(values=colors2)
ggsave("./figures/roc_by_level.png",width=7,height=5)
    
```

```{r misc_roc, include=F}
# get_avg_senspec <- function(tax_level){
#   l_senspec <- read_csv(paste0("../data/process/senspec-",tax_level,"-rf.csv"),
#                       col_types = cols(level = col_character(),.default = col_double()))
#   
#   l_avg_senspec <- l_senspec %>% 
#     group_by(threshold) %>% 
#     summarise(mean_sensitivity = mean(sensitivity),
#               sd_sensitivity = sd(sensitivity),
#               mean_specificity = mean(specificity),
#               sd_specificity = sd(specificity))  %>% 
#     mutate(level = tax_level,
#            sens_upper = mean_sensitivity + sd_sensitivity,
#            sens_lower = mean_sensitivity - sd_sensitivity) 
#   return(l_avg_senspec)
# }
#  
# all_avg_senspec <- get_avg_senspec("phylum") %>% 
#   bind_rows(get_avg_senspec("class")) %>% 
#   bind_rows(get_avg_senspec("order")) %>% 
#   bind_rows(get_avg_senspec("family")) %>% 
#   bind_rows(get_avg_senspec("genus")) %>%
#   bind_rows(get_avg_senspec("otu")) %>%
#   bind_rows(get_avg_senspec("asv")) %>% 
#   mutate(level=factor(level,levels=levels,labels=levels_names))
# 
# all_avg_senspec %>% 
#   ggplot(aes(x=1-mean_specificity,y=mean_sensitivity,
#              ymin=sens_lower,ymax=sens_upper)) +
#     geom_line(aes(color=level),alpha=0.7) +
#     geom_ribbon(aes(fill=level),alpha=0.2) +
#     coord_equal() +
#     geom_abline(slope=1,intercept = 0,lty="dashed",color="grey50") +
#     scale_x_continuous(expand = c(0,0)) +
#     scale_y_continuous(expand = c(0,0)) +
#     xlab("1 - Averaged Specificity") +
#     ylab("Averaged Sensitivity") +
#     #facet_wrap(~level,ncol=3) +
#     theme_bw() 
# 
# all_avg_senspec %>% 
#   #filter(level %in% c("Family","Genus","OTU","ASV")) %>% 
#   ggplot(aes(x=1-mean_specificity,y=mean_sensitivity,
#              ymin=sens_lower,ymax=sens_upper)) +
#     geom_line(aes(color=level),alpha=0.7) +
#     geom_ribbon(aes(fill=level),alpha=0.2) +
#     coord_equal() +
#     geom_abline(slope=1,intercept = 0,lty="dashed",color="grey50") +
#     scale_x_continuous(expand = c(0,0)) +
#     scale_y_continuous(expand = c(0,0)) +
#     xlab("1 - Averaged Specificity") +
#     ylab("Averaged Sensitivity") +
#     #facet_wrap(~level,ncol=3) +
#     theme_bw() 

# all_avg_senspec %>% 
#   ggplot(aes(x=1-mean_specificity,y=mean_sensitivity)) +
#     geom_line(aes(color=level),lwd=1.2,alpha=0.7) +
#     coord_equal() +
#     geom_abline(slope=1,intercept = 0,lty="dashed",color="grey50") +
#     scale_x_continuous(expand = c(0,0)) +
#     scale_y_continuous(expand = c(0,0)) +
#     xlab("1 - Averaged Specificity") +
#     ylab("Averaged Sensitivity") +
#     theme_bw()

```

